import{serialize as e}from"cookie";import{StatusMap as s}from"./utils";import{Cookie as t}from"./cookie";import{ELYSIA_RESPONSE as r}from"./error";let n="toJSON"in new Headers;export const isNotEmpty=e=>{for(let s in e)return!0;return!1};let o=(e,s)=>{let t=e.size;if(t&&s&&206!==s.status&&304!==s.status&&412!==s.status&&416!==s.status||!s&&t){if(s){if(s.headers instanceof Headers){if(n)s.headers=s.headers.toJSON();else for(let[e,t]of s.headers.entries())e in s.headers&&(s.headers[e]=t)}return new Response(e,{status:s.status,headers:Object.assign({"accept-ranges":"bytes","content-range":`bytes 0-${t-1}/${t}`},s.headers)})}return new Response(e,{headers:{"accept-ranges":"bytes","content-range":`bytes 0-${t-1}/${t}`}})}return new Response(e)};export const parseSetCookies=(e,s)=>{if(!e||!Array.isArray(s))return e;e.delete("Set-Cookie");for(let t=0;t<s.length;t++){let r=s[t].indexOf("=");e.append("Set-Cookie",`${s[t].slice(0,r)}=${s[t].slice(r+1)}`)}return e};export const cookieToHeader=s=>{if(!s||"object"!=typeof s||!isNotEmpty(s))return;let t=[];for(let[r,n]of Object.entries(s))if(r&&n){if(Array.isArray(n.value))for(let s=0;s<n.value.length;s++){let o=n.value[s];null!=o&&("object"==typeof o&&(o=JSON.stringify(o)),t.push(e(r,o,n)))}else{let s=n.value;if(null==s)continue;"object"==typeof s&&(s=JSON.stringify(s)),t.push(e(r,n.value,n))}}if(0!==t.length)return 1===t.length?t[0]:t};export const mapResponse=(e,a)=>{if(e?.[e.$passthrough]&&(e=e[e.$passthrough]),e?.[r]&&(a.status=e[r],e=e.response),isNotEmpty(a.headers)||200!==a.status||a.redirect||a.cookie)switch("string"==typeof a.status&&(a.status=s[a.status]),a.redirect&&(a.headers.Location=a.redirect,(!a.status||a.status<300||a.status>=400)&&(a.status=302)),a.cookie&&isNotEmpty(a.cookie)&&(a.headers["Set-Cookie"]=cookieToHeader(a.cookie)),a.headers["Set-Cookie"]&&Array.isArray(a.headers["Set-Cookie"])&&(a.headers=parseSetCookies(new Headers(a.headers),a.headers["Set-Cookie"])),e?.constructor?.name){case"String":return new Response(e,a);case"Blob":return o(e,a);case"Object":case"Array":return Response.json(e,a);case"ReadableStream":return a.headers["content-type"]?.startsWith("text/event-stream")||(a.headers["content-type"]="text/event-stream; charset=utf-8"),new Response(e,a);case void 0:if(!e)return new Response("",a);return Response.json(e,a);case"Response":let i={...a.headers};if(n)a.headers=e.headers.toJSON();else for(let[s,t]of e.headers.entries())s in a.headers&&(a.headers[s]=t);for(let s in i)e.headers.append(s,i[s]);return e;case"Error":return errorToResponse(e,a);case"Promise":return e.then(e=>mapResponse(e,a));case"Function":return mapResponse(e(),a);case"Number":case"Boolean":return new Response(e.toString(),a);case"Cookie":if(e instanceof t)return new Response(e.value,a);return new Response(e?.toString(),a);default:let p=JSON.stringify(e);if(123===p.charCodeAt(0))return a.headers["Content-Type"]||(a.headers["Content-Type"]="application/json"),new Response(JSON.stringify(e),a);return new Response(p,a)}else switch(e?.constructor?.name){case"String":return new Response(e);case"Blob":return o(e,a);case"Object":case"Array":return new Response(JSON.stringify(e),{headers:{"content-type":"application/json"}});case"ReadableStream":return new Response(e,{headers:{"Content-Type":"text/event-stream; charset=utf-8"}});case void 0:if(!e)return new Response("");return new Response(JSON.stringify(e),{headers:{"content-type":"application/json"}});case"Response":return e;case"Error":return errorToResponse(e,a);case"Promise":return e.then(e=>{let s=mapCompactResponse(e);return void 0!==s?s:new Response("")});case"Function":return mapCompactResponse(e());case"Number":case"Boolean":return new Response(e.toString());case"Cookie":if(e instanceof t)return new Response(e.value,a);return new Response(e?.toString(),a);default:let c=JSON.stringify(e);if(123===c.charCodeAt(0))return new Response(JSON.stringify(e),{headers:{"Content-Type":"application/json"}});return new Response(c)}};export const mapEarlyResponse=(e,a)=>{if(null!=e){if(e?.$passthrough&&(e=e[e.$passthrough]),e?.[r]&&(a.status=e[r],e=e.response),isNotEmpty(a.headers)||200!==a.status||a.redirect||a.cookie)switch("string"==typeof a.status&&(a.status=s[a.status]),a.redirect&&(a.headers.Location=a.redirect,(!a.status||a.status<300||a.status>=400)&&(a.status=302)),a.cookie&&isNotEmpty(a.cookie)&&(a.headers["Set-Cookie"]=cookieToHeader(a.cookie)),a.headers["Set-Cookie"]&&Array.isArray(a.headers["Set-Cookie"])&&(a.headers=parseSetCookies(new Headers(a.headers),a.headers["Set-Cookie"])),e?.constructor?.name){case"String":return new Response(e,a);case"Blob":return o(e,a);case"Object":case"Array":return Response.json(e,a);case"ReadableStream":return a.headers["content-type"]?.startsWith("text/event-stream")||(a.headers["content-type"]="text/event-stream; charset=utf-8"),new Response(e,a);case void 0:if(!e)return;return Response.json(e,a);case"Response":let i=Object.assign({},a.headers);if(n)a.headers=e.headers.toJSON();else for(let[s,t]of e.headers.entries())s in a.headers||(a.headers[s]=t);for(let s in i)e.headers.append(s,i[s]);return e.status!==a.status&&(a.status=e.status),e;case"Promise":return e.then(e=>{let s=mapEarlyResponse(e,a);if(void 0!==s)return s});case"Error":return errorToResponse(e,a);case"Function":return mapEarlyResponse(e(),a);case"Number":case"Boolean":return new Response(e.toString(),a);case"Cookie":if(e instanceof t)return new Response(e.value,a);return new Response(e?.toString(),a);default:let p=JSON.stringify(e);if(123===p.charCodeAt(0))return a.headers["Content-Type"]||(a.headers["Content-Type"]="application/json"),new Response(JSON.stringify(e),a);return new Response(p,a)}else switch(e?.constructor?.name){case"String":return new Response(e);case"Blob":return o(e,a);case"Object":case"Array":return new Response(JSON.stringify(e),{headers:{"content-type":"application/json"}});case"ReadableStream":return new Response(e,{headers:{"Content-Type":"text/event-stream; charset=utf-8"}});case void 0:if(!e)return new Response("");return new Response(JSON.stringify(e),{headers:{"content-type":"application/json"}});case"Response":return e;case"Promise":return e.then(e=>{let s=mapEarlyResponse(e,a);if(void 0!==s)return s});case"Error":return errorToResponse(e,a);case"Function":return mapCompactResponse(e());case"Number":case"Boolean":return new Response(e.toString());case"Cookie":if(e instanceof t)return new Response(e.value,a);return new Response(e?.toString(),a);default:let c=JSON.stringify(e);if(123===c.charCodeAt(0))return new Response(JSON.stringify(e),{headers:{"Content-Type":"application/json"}});return new Response(c)}}};export const mapCompactResponse=e=>{if(e?.$passthrough&&(e=e[e.$passthrough]),e?.[r])return mapResponse(e.response,{status:e[r],headers:{}});switch(e?.constructor?.name){case"String":return new Response(e);case"Blob":return o(e);case"Object":case"Array":return new Response(JSON.stringify(e),{headers:{"content-type":"application/json"}});case"ReadableStream":return new Response(e,{headers:{"Content-Type":"text/event-stream; charset=utf-8"}});case void 0:if(!e)return new Response("");return new Response(JSON.stringify(e),{headers:{"content-type":"application/json"}});case"Response":return e;case"Error":return errorToResponse(e);case"Promise":return e.then(e=>{let s=mapCompactResponse(e);return void 0!==s?s:new Response("")});case"Function":return mapCompactResponse(e());case"Number":case"Boolean":return new Response(e.toString());default:let s=JSON.stringify(e);if(123===s.charCodeAt(0))return new Response(JSON.stringify(e),{headers:{"Content-Type":"application/json"}});return new Response(s)}};export const errorToResponse=(e,s)=>new Response(JSON.stringify({name:e?.name,message:e?.message,cause:e?.cause}),{status:s?.status!==200?s?.status??500:500,headers:s?.headers});