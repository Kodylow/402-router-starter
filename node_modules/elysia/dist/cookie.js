import{parse as e}from"cookie";import{isNumericString as t,unsignCookie as r}from"./utils";import{InvalidCookieSignature as i}from"./error";export class Cookie{_value;property;name;setter;constructor(e,t={}){this._value=e,this.property=t}get(){return this._value}get value(){return this._value}set value(e){if("object"==typeof e){if(JSON.stringify(this.value)===JSON.stringify(e))return}else if(this.value===e)return;this._value=e,this.sync()}add(e){let t=Object.assign(this.property,"function"==typeof e?e(Object.assign(this.property,this.value)):e);return"value"in t&&(this._value=t.value,delete t.value),this.property=t,this.sync()}set(e){let t="function"==typeof e?e(Object.assign(this.property,this.value)):e;return"value"in t&&(this._value=t.value,delete t.value),this.property=t,this.sync()}remove(e){void 0!==this.value&&this.set({domain:e?.domain,expires:new Date(0),maxAge:0,path:e?.path,sameSite:e?.sameSite,secure:e?.secure,value:""})}get domain(){return this.property.domain}set domain(e){this.property.domain!==e&&(this.property.domain=e,this.sync())}get expires(){return this.property.expires}set expires(e){this.property.expires?.getTime()!==e?.getTime()&&(this.property.expires=e,this.sync())}get httpOnly(){return this.property.httpOnly}set httpOnly(e){this.property.domain!==e&&(this.property.httpOnly=e,this.sync())}get maxAge(){return this.property.maxAge}set maxAge(e){this.property.maxAge!==e&&(this.property.maxAge=e,this.sync())}get path(){return this.property.path}set path(e){this.property.path!==e&&(this.property.path=e,this.sync())}get priority(){return this.property.priority}set priority(e){this.property.priority!==e&&(this.property.priority=e,this.sync())}get sameSite(){return this.property.sameSite}set sameSite(e){this.property.sameSite!==e&&(this.property.sameSite=e,this.sync())}get secure(){return this.property.secure}set secure(e){this.property.secure!==e&&(this.property.secure=e,this.sync())}toString(){return"object"==typeof this.value?JSON.stringify(this.value):this.value?.toString()??""}sync(){return this.name&&this.setter&&(this.setter.cookie?this.setter.cookie[this.name]=Object.assign(this.property,{value:this.toString()}):this.setter.cookie={[this.name]:Object.assign(this.property,{value:this.toString()})}),this}}export const createCookieJar=(e,t,r)=>new Proxy(e,{get(e,i){if(i in e)return e[i];let s=new Cookie(void 0,r?{...r}:void 0);return s.setter=t,s.name=i,s},set:(e,r,i)=>i instanceof Cookie&&(t.cookie||(t.cookie={}),i.setter=t,i.name=r,i.sync(),e[r]=i,!0)});export const parseCookie=async(s,o,{secret:p,sign:n,...a}={})=>{if(!o)return createCookieJar({},s,a);let h={},y="string"==typeof p;n&&!0!==n&&!Array.isArray(n)&&(n=[n]);let u=Object.keys(e(o));for(let c=0;c<u.length;c++){let l=u[c],m=e(o)[l];if(!0===n||n?.includes(l)){if(!p)throw Error("No secret is provided to cookie plugin");if(y){if(!1===(m=await r(m,p)))throw new i(l)}else{let e=!0;for(let t=0;t<p.length;t++){let i=await r(m,p[t]);if(!1!==i){m=i,e=!1;break}}if(e)throw new i(l)}}if(void 0===m)continue;let g=m.charCodeAt(0);if(123===g||91===g)try{let e=new Cookie(JSON.parse(m));e.setter=s,e.name=l,h[l]=e;continue}catch{}t(m)?m=+m:"true"===m?m=!0:"false"===m&&(m=!1);let v=new Cookie(m,a);v.setter=s,v.name=l,h[l]=v}return createCookieJar(h,s)};