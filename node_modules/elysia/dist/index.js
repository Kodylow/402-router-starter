import{Memoirist as e}from"memoirist";import t from"eventemitter3";import{createTraceListener as s}from"./trace";import{ElysiaWS as r,websocket as i}from"./ws";import{isNotEmpty as o,mapEarlyResponse as n}from"./handler";import{composeHandler as a,composeGeneralHandler as h,composeErrorHandler as c}from"./compose";import{mergeHook as d,getSchemaValidator as f,getResponseSchemaValidator as l,mergeDeep as p,mergeCookie as u,checksum as m,mergeLifeCycle as y,filterGlobalHook as v,asGlobal as g,traceBackMacro as b,replaceUrlPath as R,primitiveHooks as k,isNumericString as E}from"./utils";import{createDynamicErrorHandler as w,createDynamicHandler as x}from"./dynamic-handle";import{isProduction as $,ERROR_CODE as H,ValidationError as q}from"./error";import{t as A}from"./type-system";export default class P{config;dependencies={};store={};decorators={};definitions={type:{},error:{}};schema={};macros=[];event={start:[],request:[],parse:[],transform:[],beforeHandle:[],afterHandle:[],mapResponse:[],onResponse:[],trace:[],error:[],stop:[]};reporter=new t;server=null;getServer(){return this.server}validator=null;router=new e;wsRouter=new e;routes=[];staticRouter={handlers:[],variables:"",map:{},all:""};wsPaths={};dynamicRouter=new e;lazyLoadModules=[];path="";stack=void 0;constructor(e){this.config={forceErrorEncapsulation:!0,prefix:"",aot:!0,strictPath:!1,scoped:!1,cookie:{},analytic:!1,...e,seed:e?.seed===void 0?"":e?.seed},e?.analytic&&(e?.name||e?.seed!==void 0)&&(this.stack=Error().stack)}add(e,t,s,r,{allowMeta:i=!1,skipPrefix:h=!1}={allowMeta:!1,skipPrefix:!1}){for(let c of("string"==typeof t&&(t=[t]),t)){if(c=""===c?c:47===c.charCodeAt(0)?c:`/${c}`,this.config.prefix&&!h&&(c=this.config.prefix+c),r?.type)switch(r.type){case"text":r.type="text/plain";break;case"json":r.type="application/json";break;case"formdata":r.type="multipart/form-data";break;case"urlencoded":r.type="application/x-www-form-urlencoded";break;case"arrayBuffer":r.type="application/octet-stream"}let t=this.definitions.type,p=f(r?.cookie??this.validator?.cookie,{dynamic:!this.config.aot,models:t,additionalProperties:!0});o(this.config.cookie??{})&&(p?p.schema=u(p.schema,this.config.cookie??{}):p=f(A.Cookie({},this.config.cookie),{dynamic:!this.config.aot,models:t,additionalProperties:!0}));let y={body:f(r?.body??this.validator?.body,{dynamic:!this.config.aot,models:t}),headers:f(r?.headers??this.validator?.headers,{dynamic:!this.config.aot,models:t,additionalProperties:!0}),params:f(r?.params??this.validator?.params,{dynamic:!this.config.aot,models:t}),query:f(r?.query??this.validator?.query,{dynamic:!this.config.aot,models:t}),cookie:p,response:l(r?.response??this.validator?.response,{dynamic:!this.config.aot,models:t})},v=this.event,g=c.endsWith("/")?c.slice(0,c.length-1):c+"/";if(this.macros.length){let e=e=>(t,s)=>{if("function"==typeof t||Array.isArray(t)){r[e]||(r[e]=[]),"function"==typeof r[e]&&(r[e]=[r[e]]),Array.isArray(t)?r[e]=r[e].concat(t):r[e].push(t);return}let{insert:i="after",stack:o="local"}=t;if("global"===o){Array.isArray(s)?"before"===i?v[e]=s.concat(v[e]):v[e]=v[e].concat(s):"before"===i?v[e].unshift(s):v[e].push(s);return}r[e]||(r[e]=[]),"function"==typeof r[e]&&(r[e]=[r[e]]),Array.isArray(s)?"before"===i?r[e]=s.concat(r[e]):r[e]=r[e].concat(s):"before"===i?r[e].unshift(s):r[e].push(s)},t={events:{global:v,local:r},onParse:e("parse"),onTransform:e("transform"),onBeforeHandle:e("beforeHandle"),onAfterHandle:e("afterHandle"),onResponse:e("onResponse"),onError:e("error")};for(let e of this.macros){let s={};for(let[e,t]of Object.entries(r??{}))k.includes(e)||(s[e]=t);e.$elysiaChecksum||(e.$elysiaChecksum=[]);let i=m(JSON.stringify(s));e.$elysiaChecksum.includes(i)||(e.$elysiaChecksum.push(m(JSON.stringify(s))),b(e(t),r))}}let R=d(v,r),E="function"==typeof s;if(!1===this.config.aot){this.dynamicRouter.add(e,c,{validator:y,hooks:R,content:r?.type,handle:s}),!1===this.config.strictPath&&this.dynamicRouter.add(e,g,{validator:y,hooks:R,content:r?.type,handle:s}),this.routes.push({method:e,path:c,composed:null,handler:s,hooks:R});return}let w=a({path:c,method:e,hooks:R,validator:y,handler:s,handleError:this.handleError,onRequest:this.event.request,config:this.config,definitions:i?this.definitions.type:void 0,schema:i?this.schema:void 0,getReporter:()=>this.reporter,setHeader:this.setHeaders});if(!E){let e;let t=Object.assign({headers:{},query:{},params:{},body:void 0,request:new Request(`http://localhost${c}`),store:this.store,path:c,set:{headers:this.setHeaders??{},status:200}},this.decorators);for(let s of Object.values(R.request))try{let r=n(s(t),t.set);if(void 0!==r){e=r;break}}catch(s){e=this.handleError(t,s);break}if(e)w.response=e;else try{w.response=w(t)}catch(e){w.response=this.handleError(t,e)}}let x=this.routes.findIndex(t=>t.path===c&&t.method===e);if(-1!==x&&this.routes.splice(x,1),this.routes.push({method:e,path:c,composed:w,handler:s,hooks:R}),"$INTERNALWS"===e){let e=this.config.strictPath?void 0:c.endsWith("/")?c.slice(0,c.length-1):c+"/";if(-1===c.indexOf(":")&&-1===c.indexOf("*")){let t=this.staticRouter.handlers.length;this.staticRouter.handlers.push(w),w.response instanceof Response?this.staticRouter.variables+=`const st${t} = staticRouter.handlers[${t}].response
`:this.staticRouter.variables+=`const st${t} = staticRouter.handlers[${t}]
`,this.wsPaths[c]=t,e&&(this.wsPaths[e]=t)}else this.wsRouter.add("ws",c,w),e&&this.wsRouter.add("ws",e,w);return}if(-1===c.indexOf(":")&&-1===c.indexOf("*")){let t=this.staticRouter.handlers.length;this.staticRouter.handlers.push(w),w.response instanceof Response?this.staticRouter.variables+=`const st${t} = staticRouter.handlers[${t}].response
`:this.staticRouter.variables+=`const st${t} = staticRouter.handlers[${t}]
`,this.staticRouter.map[c]||(this.staticRouter.map[c]={code:""}),"ALL"===e?this.staticRouter.map[c].all=`default: return st${t}(ctx)
`:w.response instanceof Response?this.staticRouter.map[c].code=`case '${e}': return st${t}.clone()
${this.staticRouter.map[c].code}`:this.staticRouter.map[c].code=`case '${e}': return st${t}(ctx)
${this.staticRouter.map[c].code}`,this.config.strictPath||(this.staticRouter.map[g]||(this.staticRouter.map[g]={code:""}),"ALL"===e?this.staticRouter.map[g].all=`default: return st${t}(ctx)
`:w.response instanceof Response?this.staticRouter.map[g].code=`case '${e}': return st${t}.clone()
${this.staticRouter.map[g].code}`:this.staticRouter.map[g].code=`case '${e}': return st${t}(ctx)
${this.staticRouter.map[g].code}`)}else this.router.add(e,c,w),this.config.strictPath||this.router.add(e,c.endsWith("/")?c.slice(0,c.length-1):c+"/",w)}}setHeaders;headers(e){return e&&(this.setHeaders||(this.setHeaders={}),this.setHeaders=p(this.setHeaders,e)),this}onStart(e){return this.on("start",e),this}onRequest(e){return this.on("request",e),this}onParse(e){return this.on("parse",e),this}onTransform(e){return this.on("transform",e),this}resolve(e){return e.$elysia="resolve",this.onBeforeHandle(e)}onBeforeHandle(e){return this.on("beforeHandle",e),this}onAfterHandle(e){return this.on("afterHandle",e),this}mapResponse(e){return this.on("mapResponse",e),this}onResponse(e){return this.on("response",e),this}trace(e){return this.reporter.on("event",s(()=>this.reporter,this.event.trace.length,e)),this.on("trace",e),this}error(e,t){switch(typeof e){case"string":return t.prototype[H]=e,this.definitions.error[e]=t,this;case"function":return this.definitions.error=e(this.definitions.error),this}for(let[t,s]of Object.entries(e))s.prototype[H]=t,this.definitions.error[t]=s;return this}onError(e){return this.on("error",e),this}onStop(e){return this.on("stop",e),this}on(e,t){for(let s of Array.isArray(t)?t:[t])switch(s=g(s),e){case"start":this.event.start.push(s);break;case"request":this.event.request.push(s);break;case"parse":this.event.parse.splice(this.event.parse.length-1,0,s);break;case"transform":this.event.transform.push(s);break;case"beforeHandle":this.event.beforeHandle.push(s);break;case"afterHandle":this.event.afterHandle.push(s);break;case"mapResponse":this.event.mapResponse.push(s);break;case"response":this.event.onResponse.push(s);break;case"trace":this.event.trace.push(s);break;case"error":this.event.error.push(s);break;case"stop":this.event.stop.push(s)}return this}group(e,t,s){let r=new P({...this.config,prefix:""});r.store=this.store,r.definitions=this.definitions,r.getServer=()=>this.server;let i="object"==typeof t,o=(i?s:t)(r);return this.decorators=p(this.decorators,r.decorators),o.event.request.length&&(this.event.request=[...this.event.request,...o.event.request]),o.event.onResponse.length&&(this.event.onResponse=[...this.event.onResponse,...o.event.onResponse]),this.model(o.definitions.type),Object.values(r.routes).forEach(({method:s,path:r,handler:n,hooks:a})=>{r=(i?"":this.config.prefix)+e+r,i?this.add(s,r,n,d(t,{...a,error:a.error?Array.isArray(a.error)?[...a.error,...o.event.error]:[a.error,...o.event.error]:o.event.error})):this.add(s,r,n,d(a,{error:o.event.error}),{skipPrefix:!0})}),this}guard(e,t){if(!t)return this.event=y(this.event,e),this.validator={body:e.body,headers:e.headers,params:e.params,query:e.query,response:e.response},this;let s=new P({...this.config,prefix:""});s.store=this.store,s.definitions=this.definitions;let r=t(s);return this.decorators=p(this.decorators,s.decorators),r.event.request.length&&(this.event.request=[...this.event.request,...r.event.request]),r.event.onResponse.length&&(this.event.onResponse=[...this.event.onResponse,...r.event.onResponse]),this.model(r.definitions.type),Object.values(s.routes).forEach(({method:t,path:s,handler:i,hooks:o})=>{this.add(t,s,i,d(e,{...o,error:o.error?Array.isArray(o.error)?[...o.error,...r.event.error]:[o.error,...r.event.error]:r.event.error}))}),this}use(e){return e instanceof Promise?(this.lazyLoadModules.push(e.then(e=>"function"==typeof e?e(this):"function"==typeof e.default?e.default(this):this._use(e)).then(e=>e.compile())),this):this._use(e)}_use(e){if("function"==typeof e){let t=e(this);return t instanceof Promise?(this.lazyLoadModules.push(t.then(e=>{if(e instanceof P){for(let{method:t,path:s,handler:r,hooks:i}of(this.compile(),Object.values(e.routes)))this.add(t,s,r,d(i,{error:e.event.error}));return e}return"function"==typeof e?e(this):"function"==typeof e.default?e.default(this):this._use(e)}).then(e=>e.compile())),this):t}let{name:t,seed:s}=e.config;e.getServer=()=>this.getServer(),this.headers(e.setHeaders);let r=e.config.scoped;if(r){if(t){t in this.dependencies||(this.dependencies[t]=[]);let r=void 0!==s?m(t+JSON.stringify(s)):0;if(this.dependencies[t].some(({checksum:e})=>r===e))return this;this.dependencies[t].push(this.config?.analytic?{name:e.config.name,seed:e.config.seed,checksum:r,dependencies:e.dependencies,stack:e.stack,routes:e.routes,decorators:e.decorators,store:e.store,type:e.definitions.type,error:e.definitions.error,derive:e.event.transform.filter(e=>"derive"===e.$elysia).map(e=>({fn:e.toString(),stack:Error().stack??""})),resolve:e.event.transform.filter(e=>"derive"===e.$elysia).map(e=>({fn:e.toString(),stack:Error().stack??""}))}:{name:e.config.name,seed:e.config.seed,checksum:r,dependencies:e.dependencies})}e.model(this.definitions.type),e.error(this.definitions.error),e.macros=[...this.macros,...e.macros],e.onRequest(e=>{Object.assign(e,this.decorators),Object.assign(e.store,this.store)}),e.event.trace=[...this.event.trace,...e.event.trace],e.config.aot&&e.compile();let r=this.mount(e.fetch);return this.routes=this.routes.concat(r.routes),this}for(let t of(e.reporter=this.reporter,e.event.trace))this.trace(t);if(t){t in this.dependencies||(this.dependencies[t]=[]);let r=void 0!==s?m(t+JSON.stringify(s)):0;this.dependencies[t].some(({checksum:e})=>r===e)||this.macros.push(...e.macros)}for(let{method:t,path:s,handler:r,hooks:i}of(this.decorate(e.decorators),this.state(e.store),this.model(e.definitions.type),this.error(e.definitions.error),Object.values(e.routes)))this.add(t,s,r,d(i,{error:e.event.error}));if(!r){if(t){t in this.dependencies||(this.dependencies[t]=[]);let r=void 0!==s?m(t+JSON.stringify(s)):0;if(this.dependencies[t].some(({checksum:e})=>r===e))return this;this.dependencies[t].push(this.config?.analytic?{name:e.config.name,seed:e.config.seed,checksum:r,dependencies:e.dependencies,stack:e.stack,routes:e.routes,decorators:e.decorators,store:e.store,type:e.definitions.type,error:e.definitions.error,derive:e.event.transform.filter(e=>e?.$elysia==="derive").map(e=>({fn:e.toString(),stack:Error().stack??""})),resolve:e.event.transform.filter(e=>e?.$elysia==="resolve").map(e=>({fn:e.toString(),stack:Error().stack??""}))}:{name:e.config.name,seed:e.config.seed,checksum:r,dependencies:e.dependencies}),this.event=y(this.event,v(e.event),r)}else this.event=y(this.event,v(e.event))}return this}macro(e){return this.macros.push(e),this}mount(e,t){if(e instanceof P||"function"==typeof e||0===e.length||"/"===e){let s="function"==typeof e?e:e instanceof P?e.compile().fetch:t instanceof P?t.compile().fetch:t,r=async({request:e,path:t})=>s(new Request(R(e.url,t||"/"),e));return this.all("/",r,{type:"none"}),this.all("/*",r,{type:"none"}),this}let s=e.length;t instanceof P&&(t=t.compile().fetch);let r=async({request:e,path:r})=>t(new Request(R(e.url,r.slice(s)||"/"),e));return this.all(e,r,{type:"none"}),this.all(e+(e.endsWith("/")?"*":"/*"),r,{type:"none"}),this}get(e,t,s){return this.add("GET",e,t,s),this}post(e,t,s){return this.add("POST",e,t,s),this}put(e,t,s){return this.add("PUT",e,t,s),this}patch(e,t,s){return this.add("PATCH",e,t,s),this}delete(e,t,s){return this.add("DELETE",e,t,s),this}options(e,t,s){return this.add("OPTIONS",e,t,s),this}all(e,t,s){return this.add("ALL",e,t,s),this}head(e,t,s){return this.add("HEAD",e,t,s),this}connect(e,t,s){return this.add("CONNECT",e,t,s),this}ws(e,t){let s=t.transformMessage?Array.isArray(t.transformMessage)?t.transformMessage:[t.transformMessage]:void 0,i=null,o=f(t?.body,{models:this.definitions.type}),n=f(t?.response,{models:this.definitions.type}),a=e=>{if("string"==typeof e){let t=e?.charCodeAt(0);if(47===t||123===t)try{e=JSON.parse(e)}catch{}else E(e)&&(e=+e)}if(s?.length)for(let t=0;t<s.length;t++){let r=s[t](e);void 0!==r&&(e=r)}return e};return this.route("$INTERNALWS",e,e=>{let{set:s,path:h,qi:c,headers:d,query:f,params:l}=e;if(null===i&&(i=this.getServer()),!i?.upgrade(e.request,{headers:"function"==typeof t.upgrade?t.upgrade(e):t.upgrade,data:{validator:n,open(s){t.open?.(new r(s,e))},message:(s,i)=>{let n=a(i);if(o?.Check(n)===!1)return void s.send(new q("message",o,n).message);t.message?.(new r(s,e),n)},drain(s){t.drain?.(new r(s,e))},close(s,i,o){t.close?.(new r(s,e),i,o)}}}))return s.status=400,"Expected a websocket connection"},{beforeHandle:t.beforeHandle,transform:t.transform,headers:t.headers,params:t.params,query:t.query}),this}route(e,t,s,{config:r,...i}={config:{allowMeta:!1}}){return this.add(e,t,s,i,r),this}state(e,t){switch(typeof e){case"object":return this.store=p(this.store,e),this;case"function":return this.store=e(this.store),this}return e in this.store||(this.store[e]=t),this}decorate(e,t){switch(typeof e){case"object":return this.decorators=p(this.decorators,e),this;case"function":return this.decorators=e(this.decorators),this}return e in this.decorators||(this.decorators[e]=t),this}derive(e){return e.$elysia="derive",this.onTransform(e)}model(e,t){switch(typeof e){case"object":return Object.entries(e).forEach(([e,t])=>{e in this.definitions.type||(this.definitions.type[e]=t)}),this;case"function":return this.definitions.type=e(this.definitions.type),this}return this.definitions.type[e]=t,this}mapDerive(e){return e.$elysia="derive",this.onTransform(e)}affix(e,t,s){if(""===s)return this;let r=["_","-"," "],i=e=>e[0].toUpperCase()+e.slice(1),o="prefix"===e?(e,t)=>r.includes(e.at(-1)??"")?e+t:e+i(t):r.includes(s.at(-1)??"")?(e,t)=>t+e:(e,t)=>t+i(e),n=e=>{let t={};switch(e){case"decorator":for(let e in this.decorators)t[o(s,e)]=this.decorators[e];this.decorators=t;break;case"state":for(let e in this.store)t[o(s,e)]=this.store[e];this.store=t;break;case"model":for(let e in this.definitions.type)t[o(s,e)]=this.definitions.type[e];this.definitions.type=t;break;case"error":for(let e in this.definitions.error)t[o(s,e)]=this.definitions.error[e];this.definitions.error=t}},a=Array.isArray(t)?t:[t];for(let e of a.some(e=>"all"===e)?["decorator","state","model","error"]:a)n(e);return this}prefix(e,t){return this.affix("prefix",e,t)}suffix(e,t){return this.affix("suffix",e,t)}compile(){return this.fetch=this.config.aot?h(this):x(this),"function"==typeof this.server?.reload&&this.server.reload({...this.server,fetch:this.fetch}),this}handle=async e=>this.fetch(e);fetch=e=>("production"===process.env.NODE_ENV&&console.warn("Performance degradation found. Please call Elysia.compile() before using 'fetch'"),(this.fetch=this.config.aot?h(this):x(this))(e));handleError=async(e,t)=>(this.handleError=this.config.aot?c(this):w(this))(e,t);outerErrorHandler=e=>new Response(e.message||e.name||"Error",{status:e?.status??500});listen=(e,t)=>{if(!Bun)throw Error("Bun to run");if(this.compile(),"string"==typeof e&&Number.isNaN(e=+e.trim()))throw Error("Port must be a numeric value");let s=this.fetch,r="object"==typeof e?{development:!$,reusePort:!0,...this.config.serve,...e,websocket:{...this.config.websocket,...i},fetch:s,error:this.outerErrorHandler}:{development:!$,reusePort:!0,...this.config.serve,websocket:{...this.config.websocket,...i},port:e,fetch:s,error:this.outerErrorHandler};if("undefined"==typeof Bun)throw Error(".listen() is designed to run on Bun only. If you are running Elysia in other environment please use a dedicated plugin or export the handler via Elysia.fetch");if(this.server=Bun?.serve(r),this.event.start.length)for(let e=0;e<this.event.start.length;e++)this.event.start[e](this);return t&&t(this.server),process.on("beforeExit",()=>{for(let e=0;e<this.event.stop.length;e++)this.event.stop[e](this)}),Promise.all(this.lazyLoadModules).then(()=>{Bun?.gc(!1)}),this};stop=async()=>{if(!this.server)throw Error("Elysia isn't running. Call `app.listen` to start the server.");if(this.server.stop(),this.event.stop.length)for(let e=0;e<this.event.stop.length;e++)this.event.stop[e](this)};get modules(){return Promise.all(this.lazyLoadModules)}}export{mapResponse,mapCompactResponse,mapEarlyResponse}from"./handler";export{t}from"./type-system";export{Cookie}from"./cookie";export{getSchemaValidator,mergeDeep,mergeHook,mergeObjectArray,getResponseSchemaValidator}from"./utils";export{error,ParseError,NotFoundError,ValidationError,InternalServerError,InvalidCookieSignature}from"./error";export{P as Elysia};